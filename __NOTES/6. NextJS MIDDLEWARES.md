# MIDDLEWARES

***

TO BE CLEAR: THESE ARE NOT EXPRESS MIDDLEWARES

***

***

ONLY WHEN YOU DEPLOY YOUR APP ON VERCEL, VERCEL WILL USE EDGE FUNCTIONS FROM AWS I THINK; YOUR MIDDLEWARE WILL ONLY THEN BE AN EDGE FUNCTION

***

THESE ARE **EDGE FUNCTIONS** (SIMILAR TO AWS LAMBDA OR CLOUDFLARE WORKERS), I AM GOING TO USE IN THIS PROJECT

**THIS EDGE FUNCTION IS NOT IN NODEJS ENVIRONMENT; ALSO IT DOSEN'T HAVE ANYTHING TO DO WITH FRONTEND; IT IS NOT IN A NODE ENVIRONMENT LIKE OUR DATBASE SEED SCRIPT; `IT IS MORE LIKE A WEB WORKER ENVIRONMENT`** (YOU DON'T HAVE MUCH SPECIAL THINGS THAT YOU CAN DO IN THESE FUNCTIONS (DON'T HAVE ACCESS TO GLOBALS), BECAUSE THESE FUNCTIONS, THEY NEED TO BE FAST, SO YOU HAVE ACCESS TO SOME LOW LEVEL PRIMITIVES LIKE RESPONSE OBJECT AND A REQUEST OBJECT)

I AM GOING TO USE THEM FOR AUTHENTICATION

**BUT WE CAN'T USE DATBASE WITH EDGE FUNCTION (WE CAN'T IMPORT DATBASE CLIENT); SO WE CAN ONLY CHECK COOKIES FOR THE PAGES WE WANT TO PROTECT**

READ MORE ABOUT THEM [OVER HERE](https://nextjs.org/docs/advanced-features/middleware)

<https://nextjs.org/docs/api-reference/next/server>

<https://nextjs.org/docs/api-reference/edge-runtime>

# I AM GOING TO SHOW YOU HOW I USED MIDDLEWARES IN THIS PROJECT

**YOU CAN DEFINE MIDDLEWARE FOR YOUR API ROUTE, YOU ALSO CAN DEFINE MIDDLEWARE IN FRONT OF YOUR PAGES**

**IN DOCS THEY DIDN'T MENTIONED THAT YOU NEED UNDERSCORE FOR THE MIDDLEWARE: LIKE THIS _middleware**

SO I CREATED `middleware.ts` FILE

**AN IT NEEDS TO BE AT ROOT OF YOUR PROJECT**

**YOU CAN'T CREATE MIDDLEWARE FILE PER ROUTE (NESTED MIDDLEWARES) LIKE BEFORE (CHANGES TO THE MIDDLEWARE API)**

**SO YOU CAN CREATE ONLY ONE MIDDLEWARE FILE**

```
touch middleware.ts
```

IN HERE YOU CAN CONDITIONALY DO SOME THINGS FOR SPECIFIC ROUTES YOU WANT

I PROTECTED FEW

```ts
import type { NextRequest } from "next/server";
import { NextResponse } from "next/server";

// PAGES WE WANT TO PROTECT
const pagesToProtect = ["/", "/library", "/liked-songs"];

// YOU DEFINE A NAMED IMPORT (NOT DEFAULT)

export function middleware(req: NextRequest) {
  if (pagesToProtect.find((p) => req.nextUrl.pathname === p)) {
    const token = req.cookies.get("SONGIFY_ACCESS_TOKEN");

    if (!token) {
      // YOU NEED ABSOLUTE URLS FOR REDIRECT
      return NextResponse.redirect(`${req.nextUrl.origin}/auth`);
    }
  }
}

```

FOR MORE THINGS CHECK THE DOCS; BECAUSE I SAW THAT YOU CAN ADD CONFIG FILE TOO

<>



***

FIND OUT IF EDGE IS EXPENSIVE

***